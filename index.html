<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ NuclearLab - An√°lisis de Is√≥topos Radiactivos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS MODERNO Y COMPLETO --- */
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #1d3557;
            --gray: #6c757d;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 15px;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 25px 0;
            margin-bottom: 20px;
            position: relative;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            color: var(--primary);
        }
        
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #5a6b8c;
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .tabs-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .tabs {
            display: flex;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 0;
        }
        
        .tab {
            flex: 1;
            padding: 16px 10px;
            color: rgba(255,255,255,0.8);
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            font-size: 1.05rem;
            transition: var(--transition);
            position: relative;
        }
        
        .tab:hover {
            color: white;
        }
        
        .tab.active {
            color: white;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: white;
            border-radius: 4px 4px 0 0;
        }
        
        .tab i {
            margin-right: 8px;
            font-size: 1.1rem;
        }
        
        .tab-content {
            padding: 25px;
            min-height: 600px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--primary);
            font-size: 1.2rem;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .parameter-group {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e2e8f0;
        }
        
        .parameter-group h4 {
            margin-bottom: 12px;
            color: var(--secondary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parameter-group h4 i {
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .chart-container-wrapper {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin: 25px 0;
            height: 500px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .chart-actions {
            display: flex;
            gap: 10px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }
        
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .result-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .result-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .result-unit {
            font-size: 0.85rem;
            opacity: 0.85;
        }
        
        .equation-display {
            background: #1e293b;
            color: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #334155;
        }
        
        .data-table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            padding: 14px 12px;
            text-align: center;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        tr:hover {
            background-color: #edf2f7;
        }
        
        .message-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease forwards;
            transform: translateX(120%);
        }
        
        @keyframes slideIn {
            to { transform: translateX(0); }
        }
        
        .message.success {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            color: white;
            border-left: 4px solid #047857;
        }
        
        .message.error {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-left: 4px solid #b91c1c;
        }
        
        .message.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-left: 4px solid #b45309;
        }
        
        #dataTableBody tr:first-child {
            background-color: #fff8e1 !important;
            border-left: 4px solid #ffc107;
        }
        
        #dataTableBody tr:first-child td {
            font-weight: bold;
        }
        
        input[type="number"]:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.3);
            outline: none;
        }
        
        .table-footer {
            padding: 12px;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }
        
        .table-header {
            padding: 12px 15px;
            background-color: #2c3e50;
            color: white;
            border-bottom: 2px solid #1a252f;
        }
        
        .table-header h3 {
            margin: 0;
            color: white;
        }
        
        .table-header p {
            margin: 5px 0 0 0;
            color: #a3b1c6;
            font-size: 14px;
        }
        
        .app-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 14px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
            margin-left: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .app-button:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
        }
        
        .highlight-section {
            background-color: #fff8e1;
            border: 1px solid #ffecb3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .highlight-section h4 {
            color: #e65100;
            margin-top: 0;
            font-size: 18px;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .parameters-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .logo {
                flex-direction: column;
                gap: 8px;
            }
            
            .card-header {
                flex-direction: column;
                text-align: center;
            }
            
            .card-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .additional-results {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fas fa-atom logo-icon"></i>
                <div>
                    <h1>NuclearLab Interactive</h1>
                    <p class="subtitle">Plataforma avanzada para el an√°lisis de datos en experimentos de Tecnolog√≠a Nuclear</p>
                </div>
            </div>
        </header>
        
        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" data-tab="input">
                    <i class="fas fa-database"></i> Datos Experimentales
                </div>
                <div class="tab" data-tab="parameters">
                    <i class="fas fa-sliders-h"></i> Par√°metros del Experimento
                </div>
                <div class="tab" data-tab="analysis">
                    <i class="fas fa-chart-line"></i> An√°lisis y Resultados
                </div>
            </div>
            
            <div class="tab-content">
                <!-- Pesta√±a 1: Datos Experimentales -->
                <div class="tab-pane active" id="input-tab">
                    <div class="highlight-section">
                        <h4>‚ÑπÔ∏è Instrucciones:</h4>
                        <p>1. Introduce los par√°metros de irradiaci√≥n y tiempos.<br>
                           2. Ingresa los datos experimentales en la tabla (<strong>la primera fila es para la medida larga, introduce manualmente el el valor de tiempo=te+tc/2</strong> ).<br>
                           3. Pulsa <strong>"Calcular Lambda"</strong> para obtener los resultados del an√°lisis.</p>
                    </div>
                    
                    <div class="parameters-grid">
                        <div class="parameter-group">
                            <h4><i class="fas fa-table"></i> Configuraci√≥n de la Tabla</h4>
                            <div class="form-group">
                                <label for="rowCount">N√∫mero de datos</label>
                                <input type="number" id="rowCount" class="form-control" value="10" min="5" max="100" step="1">
                            </div>
                            <div class="form-group">
                                <label for="startTime">Tiempo total de espera(te+tc+tp) (min)</label>
                                <input type="number" id="startTime" class="form-control" value="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="timeStep">Paso de tiempo (min)</label>
                                <input type="number" id="timeStep" class="form-control" value="1" step="0.1">
                            </div>
                            <button class="btn btn-primary" onclick="resizeTable()">
                                <i class="fas fa-sync-alt"></i> Actualizar Tabla
                            </button>
                        </div>
                        
                        <div class="parameter-group">
                            <h4><i class="fas fa-file-import"></i> Importar Datos</h4>
                            <div class="form-group">
                                <label for="fileInput">Cargar archivo de datos (.txt)</label>
                                <input type="file" id="fileInput" class="form-control" accept=".txt,text/plain">
                            </div>
                            <button class="btn btn-outline" onclick="loadActivityFromFile()">
                                <i class="fas fa-upload"></i> Cargar actividad
                            </button>
                            <button class="btn btn-outline" onclick="autoFillTimes()" style="margin-top: 10px;">
                                <i class="fas fa-magic"></i> Rellenar tiempos autom√°ticamente
                            </button>
                            <button class="btn btn-outline" onclick="showDataPreview()" style="margin-top: 10px;">
                                <i class="fas fa-eye"></i> Vista previa de datos
                            </button>
                        </div>
                        
                        <div class="parameter-group">
                            <h4><i class="fas fa-microphone-alt-slash"></i> Correcci√≥n de Fondo</h4>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="useBackground" checked>
                                    Aplicar correcci√≥n de fondo
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="backgroundMethod">M√©todo de c√°lculo</label>
                                <select id="backgroundMethod" class="form-control">
                                    <option value="auto">Autom√°tico (primeros puntos)</option>
                                    <option value="manual">Valor manual</option>
                                </select>
                            </div>
                            <div id="manualBackgroundContainer">
                                <div class="form-group">
                                    <label for="manualBackgroundValue">Valor del fondo (C/min)</label>
                                    <input type="number" id="manualBackgroundValue" class="form-control" value="50" step="0.1" min="0">
                                </div>
                            </div>
                            <div id="autoBackgroundContainer">
                                <div class="form-group">
                                    <label for="backgroundPoints">Puntos para calcular fondo</label>
                                    <input type="number" id="backgroundPoints" class="form-control" value="5" min="3" max="15" step="1">
                                </div>
                            </div>
                            <button class="btn btn-warning" onclick="calculateBackground()">
                                <i class="fas fa-calculator"></i> Calcular fondo
                            </button>
                            <button class="btn btn-outline" onclick="applyBackgroundToTable()" style="margin-top: 10px;">
                                <i class="fas fa-check-circle"></i> Aplicar a tabla
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-table"></i>
                            </div>
                            <h3 class="card-title">Tabla de Datos Experimentales</h3>
                        </div>
                        <div class="table-header">
                            <h3>üìã Tabla de Datos Experimentales</h3>
                            <p>Introduzca los valores de tiempo y actividades. 
                            <strong style="color: #e74c3c;">La primera fila corresponde a la MEDIDA LARGA (5 minutos)</strong></p>
                        </div>
                        <div class="data-table-container">
                            <table id="dataTable">
                                <thead>
                                    <tr>
                                        <th>Tiempo (min)<br><small>desde fin irradiaci√≥n</small></th>
                                        <th>Cuentas Totales<br><small>(cuentas)</small></th>
                                        <th>Tiempo de Contaje<br><small>(minutos)</small></th>
                                        <th>Actividad Neta<br><small>(C/min)</small></th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="table-footer">
                            <button onclick="addRow()" class="btn btn-outline" style="margin-right: 10px;">
                                <i class="fas fa-plus"></i> A√±adir fila
                            </button>
                            <button onclick="clearTable()" class="btn btn-outline">
                                <i class="fas fa-trash"></i> Limpiar tabla
                            </button>
                            <span style="margin-left: 15px; color: #7f8c8d; font-size: 14px;">
                                Total filas: <span id="rowCountDisplay">10</span>
                            </span>
                        </div>
                    </div>
                    
                    <div id="dataPreview" style="display: none;"></div>
                </div>
                
                <!-- Pesta√±a 2: Par√°metros del Experimento -->
                <div class="tab-pane" id="parameters-tab">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            <h3 class="card-title">Configuraci√≥n del Experimento</h3>
                        </div>
                        
                        <div class="parameters-grid">
                            <div class="parameter-group">
                                <h4><i class="fas fa-sun"></i> Par√°metros de Irradiaci√≥n</h4>
                                <div class="form-group">
                                    <label for="irradiationTime">Tiempo de irradiaci√≥n (min)</label>
                                    <input type="number" id="irradiationTime" class="form-control" value="10" step="0.1" min="0.1">
                                    <small class="form-text" style="color: var(--gray); margin-top: 4px; display: block;">
                                        Duraci√≥n de la exposici√≥n a la fuente de neutrones
                                    </small>
                                </div>
                            </div>
                            
                            <div class="parameter-group">
                                <h4><i class="fas fa-snowflake"></i> Par√°metros de Enfriamiento</h4>
                                <div class="form-group">
                                    <label for="coolingTime">Tiempo de enfriamiento (min)</label>
                                    <input type="number" id="coolingTime" class="form-control" value="10" step="0.1" min="0">
                                    <small class="form-text" style="color: var(--gray); margin-top: 4px; display: block;">
                                        Tiempo transcurrido entre el fin de la irradiaci√≥n y el inicio de la primera medida
                                    </small>
                                </div>
                            </div>
                            
                            <div class="parameter-group">
                                <h4><i class="fas fa-hourglass-half"></i> Par√°metros de Medida</h4>
                                <div class="form-group">
                                    <label for="longCountTime">Tiempo de contaje medida larga (min)</label>
                                    <input type="number" id="longCountTime" class="form-control" value="5" step="0.1" min="0.1">
                                    <small class="form-text" style="color: var(--gray); margin-top: 4px; display: block;">
                                        Duraci√≥n de la primera medida (normalmente m√°s larga)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <h3 class="card-title">Instrucciones para el An√°lisis</h3>
                        </div>
                        <div style="padding: 15px;">
                            <div style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <h4 style="color: #1976d2; margin-bottom: 8px;"><i class="fas fa-star"></i> Primer Paso: Medida Larga</h4>
                                <p>La primera fila de la tabla corresponde a tu medida larga (5 minutos). Introduce:</p>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    <li>El tiempo total desde el fin de la irradiaci√≥n hasta el centro de la medida</li>
                                    <li>El total de cuentas registradas durante los 5 minutos</li>
                                    <li>El tiempo de contaje (5 minutos)</li>
                                </ul>
                            </div>
                            
                            <div style="background-color: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <h4 style="color: #2e7d32; margin-bottom: 8px;"><i class="fas fa-chart-line"></i> Segundo Paso: Medidas Recurrentes</h4>
                                <p>Las filas siguientes corresponden a tus medidas recurrentes (1 minuto cada una). Introduce:</p>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    <li>El tiempo desde el fin de la irradiaci√≥n hasta cada medida</li>
                                    <li>El total de cuentas para cada medida de 1 minuto</li>
                                    <li>El tiempo de contaje (1 minuto para cada una)</li>
                                </ul>
                            </div>
                            
                            <div style="background-color: #fff8e1; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #e65100; margin-bottom: 8px;"><i class="fas fa-calculator"></i> Tercer Paso: Calcular Resultados</h4>
                                <p>Una vez completados los datos, ve a la pesta√±a de "An√°lisis y Resultados" y pulsa el bot√≥n para calcular:</p>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    <li>La constante de desintegraci√≥n (Œª)</li>
                                    <li>T1/2 del is√≥topo</li>
                                    <li>La actividad inicial A(0)</li>
                                    <li>La actividad de saturaci√≥n As</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pesta√±a 3: An√°lisis y Resultados -->
                <div class="tab-pane" id="analysis-tab">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-play"></i>
                            </div>
                            <h3 class="card-title">Ejecutar An√°lisis</h3>
                        </div>
                        <p style="margin: 15px 0 20px; color: var(--gray);">
                            Al pulsar el bot√≥n, el sistema calcular√° la constante de desintegraci√≥n (Œª), T1/2, 
                            la actividad inicial y la actividad de saturaci√≥n utilizando los datos experimentales y par√°metros definidos.
                        </p>
                        <div style="text-align: center;">
                            <button class="btn btn-primary" style="padding: 15px 40px; font-size: 1.2rem;" onclick="calculateLambda()">
                                <i class="fas fa-calculator"></i> Ejecutar An√°lisis Completo
                            </button>
                        </div>
                    </div>
                    
                    <div id="resultsPlaceholder" style="text-align: center; padding: 40px 20px; color: var(--gray);">
                        <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.7;"></i>
                        <h3 style="margin-bottom: 15px; color: var(--dark);">Resultados del An√°lisis</h3>
                        <p>Los resultados aparecer√°n aqu√≠ despu√©s de ejecutar el an√°lisis. Se mostrar√°n los valores calculados, la ecuaci√≥n de ajuste y los gr√°ficos correspondientes.</p>
                    </div>
                    
                    <div id="resultsSection" style="display: none;">
                        <div class="equation-display" id="equation">
                            A(t) = A‚ÇÄ ¬∑ e^(-Œª¬∑t)
                        </div>
                        
                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-label">Constante de desintegraci√≥n</div>
                                <div class="result-value" id="lambdaValue">-</div>
                                <div class="result-unit">min‚Åª¬π</div>
                            </div>
                            
                            <div class="result-card" style="background: linear-gradient(135deg, #3a86ff 0%, #8338ec 100%);">
                                <div class="result-label">Actividad inicial A(0)</div>
                                <div class="result-value" id="a0Value">-</div>
                                <div class="result-unit">C/min</div>
                            </div>
                            
                            <div class="result-card" style="background: linear-gradient(135deg, #ff9e6d 0%, #ff5400 100%);">
                                <div class="result-label">T<sub>1/2</sub></div>
                                <div class="result-value" id="halfLifeValue">-</div>
                                <div class="result-unit">minutos</div>
                            </div>
                            
                            <div class="result-card" style="background: linear-gradient(135deg, #16c79a 0%, #1bb8b8 100%);">
                                <div class="result-label">Actividad de saturaci√≥n</div>
                                <div class="result-value" id="saturationActivityValue">-</div>
                                <div class="result-unit">C/min</div>
                            </div>
                        </div>
                        
                        <div class="chart-container-wrapper">
                            <div class="chart-header">
                                <h3 style="font-size: 1.3rem; color: var(--dark); margin: 0;">Gr√°fica de Ajuste Exponencial</h3>
                                <div class="chart-actions">
                                    <button class="btn btn-outline" onclick="exportResults()">
                                        <i class="fas fa-file-export"></i> Exportar Datos
                                    </button>
                                    <button class="btn btn-outline" onclick="exportChart()">
                                        <i class="fas fa-image"></i> Exportar Gr√°fica
                                    </button>
                                </div>
                            </div>
                            <canvas id="resultsChart" style="height: 400px;"></canvas>
                        </div>
                        
                        <div class="card" style="margin-top: 25px;">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-table"></i>
                                </div>
                                <h3 class="card-title">Datos Experimentales vs Ajuste Te√≥rico</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                    <thead>
                                        <tr>
                                            <th style="padding: 12px; background: var(--primary); color: white;">Tiempo (min)</th>
                                            <th style="padding: 12px; background: var(--primary); color: white;">Actividad Experimental (C/min)</th>
                                            <th style="padding: 12px; background: var(--primary); color: white;">Actividad Te√≥rica (C/min)</th>
                                            <th style="padding: 12px; background: var(--primary); color: white;">Error (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTableBody">
                                        <tr>
                                            <td colspan="4" style="text-align: center; padding: 20px; color: var(--gray);">
                                                Los datos aparecer√°n aqu√≠ despu√©s del an√°lisis
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 25px;">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <h3 class="card-title">An√°lisis de Calidad del Ajuste</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                                <div class="parameter-group" style="background: #e3f2fd; border-color: #bbdefb;">
                                    <h4 style="color: #1976d2;"><i class="fas fa-chart-pie"></i> Coeficiente de Determinaci√≥n</h4>
                                    <div style="font-size: 2rem; font-weight: 700; color: #1565c0; margin: 10px 0;" id="rSquared">-</div>
                                    <p style="color: #546e7a;">Valores cercanos a 1 indican un buen ajuste</p>
                                </div>
                                
                                <div class="parameter-group" style="background: #e8f5e9; border-color: #c8e6c9;">
                                    <h4 style="color: #2e7d32;"><i class="fas fa-check-circle"></i> Factor de Saturaci√≥n</h4>
                                    <div style="font-size: 2rem; font-weight: 700; color: #2e7d32; margin: 10px 0;" id="saturationFactorValue">-</div>
                                    <p style="color: #546e7a;">Relaci√≥n A(0)/A<sub>s</sub></p>
                                </div>
                                
                                <div class="parameter-group" style="background: #fff8e1; border-color: #ffecb3;">
                                    <h4 style="color: #e65100;"><i class="fas fa-ruler-vertical"></i> Valor del Fondo</h4>
                                    <div style="font-size: 2rem; font-weight: 700; color: #e65100; margin: 10px 0;" id="backgroundValue">-</div>
                                    <p style="color: #546e7a;">Cuentas por minuto</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="message-container" id="messageContainer"></div>
    </div>
    
    <script>
        let myChart = null;
        let backgroundValue = 50.0;
        let backgroundError = Math.sqrt(50.0);
        
        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Hide all tab panes
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });
                
                // Show the corresponding tab pane
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Initialize the table on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeTable();
            setupBackgroundListeners();
            document.getElementById('rowCountDisplay').textContent = document.getElementById('rowCount').value;
        });
        
        function setupBackgroundListeners() {
            const backgroundMethod = document.getElementById('backgroundMethod');
            const autoContainer = document.getElementById('autoBackgroundContainer');
            const manualContainer = document.getElementById('manualBackgroundContainer');
            
            backgroundMethod.addEventListener('change', () => {
                if (backgroundMethod.value === 'auto') {
                    autoContainer.style.display = 'block';
                    manualContainer.style.display = 'none';
                } else {
                    autoContainer.style.display = 'none';
                    manualContainer.style.display = 'block';
                }
            });
            
            // Initialize background containers
            if (backgroundMethod.value === 'auto') {
                autoContainer.style.display = 'block';
                manualContainer.style.display = 'none';
            } else {
                autoContainer.style.display = 'none';
                manualContainer.style.display = 'block';
            }
        }
        
        function initializeTable() {
            const rowCount = parseInt(document.getElementById('rowCount').value) || 10;
            const tbody = document.getElementById('dataTableBody');
            if (!tbody) {
                console.error("Elemento 'dataTableBody' no encontrado.");
                return;
            }
            tbody.innerHTML = '';
            
            // Add description row for the first measurement
            const descRow = document.createElement('tr');
            const descCell = document.createElement('td');
            descCell.colSpan = 4;
            descCell.style.backgroundColor = '#fff8e1';
            descCell.style.fontWeight = 'bold';
            descCell.style.textAlign = 'center';
            descCell.style.padding = '12px';
            descCell.innerHTML = '<i class="fas fa-star"></i> PRIMERA FILA: MEDIDA LARGA (Usada para calcular la actividad de saturaci√≥n)';
            descRow.appendChild(descCell);
            tbody.appendChild(descRow);
            
            // Add data rows
            for (let i = 0; i < rowCount; i++) {
                const row = document.createElement('tr');
                if (i === 0) {
                    row.style.backgroundColor = '#fff3e0';
                    row.style.fontWeight = 'bold';
                }
                
                // Time column
                const timeCell = document.createElement('td');
                const timeInput = document.createElement('input');
                timeInput.type = 'number';
                timeInput.step = '0.1';
                timeInput.value = i === 0 ? '12.5' : (i * 1).toFixed(1);
                timeInput.className = 'time-input form-control';
                timeInput.dataset.index = i;
                timeCell.appendChild(timeInput);
                
                // Counts column
                const countsCell = document.createElement('td');
                const countsInput = document.createElement('input');
                countsInput.type = 'number';
                countsInput.step = '1';
                countsInput.min = '0';
                countsInput.value = i === 0 ? '5680' : '0';
                countsInput.className = 'counts-input form-control';
                countsInput.dataset.index = i;
                countsInput.addEventListener('change', function() {
                    updateActivity(this);
                });
                countsCell.appendChild(countsInput);
                
                // Time count column
                const timeCountCell = document.createElement('td');
                const timeCountInput = document.createElement('input');
                timeCountInput.type = 'number';
                timeCountInput.step = '0.1';
                timeCountInput.min = '0.1';
                timeCountInput.value = i === 0 ? '5.0' : '1.0';
                timeCountInput.className = 'time-count-input form-control';
                timeCountInput.dataset.index = i;
                timeCountInput.addEventListener('change', function() {
                    updateActivity(this);
                });
                timeCountCell.appendChild(timeCountInput);
                
                // Net activity column (calculated)
                const netActivityCell = document.createElement('td');
                const netValue = i === 0 ? (5680 / 5).toFixed(2) : '0.00';
                netActivityCell.textContent = netValue;
                netActivityCell.className = 'net-activity';
                netActivityCell.dataset.index = i;
                
                row.appendChild(timeCell);
                row.appendChild(countsCell);
                row.appendChild(timeCountCell);
                row.appendChild(netActivityCell);
                
                tbody.appendChild(row);
            }
            
            // Update all net activities
            document.querySelectorAll('.counts-input, .time-count-input').forEach(updateActivity);
        }
        
        function updateActivity(inputElement) {
            try {
                const rowIndex = parseInt(inputElement.dataset.index);
                if (isNaN(rowIndex)) {
                    console.error("√çndice no encontrado en input.");
                    return;
                }
                
                const countsInputs = document.querySelectorAll('.counts-input');
                const timeCountInputs = document.querySelectorAll('.time-count-input');
                const netActivityCells = document.querySelectorAll('.net-activity');
                
                if (rowIndex >= countsInputs.length || rowIndex >= timeCountInputs.length || rowIndex >= netActivityCells.length) {
                    console.error("√çndice de fila fuera de rango.");
                    return;
                }
                
                const counts = parseFloat(countsInputs[rowIndex].value) || 0;
                const timeCount = parseFloat(timeCountInputs[rowIndex].value) || 1;
                const useBackground = document.getElementById('useBackground').checked;
                const background = useBackground ? backgroundValue : 0;
                
                // Calcular actividad neta en C/min
                const netCounts = Math.max(0, counts - background);
                const netActivity = netCounts / timeCount;
                
                netActivityCells[rowIndex].textContent = netActivity.toFixed(2);
            } catch (error) {
                console.error("Error en updateActivity:", error);
            }
        }
        
        function resizeTable() {
            try {
                const rowCount = parseInt(document.getElementById('rowCount').value) || 10;
                const tbody = document.getElementById('dataTableBody');
                if (!tbody) {
                    console.error("Elemento 'dataTableBody' no encontrado.");
                    return;
                }
                tbody.innerHTML = '';
                
                const startTime = parseFloat(document.getElementById('startTime').value) || 0;
                const timeStep = parseFloat(document.getElementById('timeStep').value) || 1;
                
                // Add description row for the first measurement
                const descRow = document.createElement('tr');
                const descCell = document.createElement('td');
                descCell.colSpan = 4;
                descCell.style.backgroundColor = '#fff8e1';
                descCell.style.fontWeight = 'bold';
                descCell.style.textAlign = 'center';
                descCell.style.padding = '12px';
                descCell.innerHTML = '<i class="fas fa-star"></i> PRIMERA FILA: MEDIDA LARGA (Usada para calcular la actividad de saturaci√≥n)';
                descRow.appendChild(descCell);
                tbody.appendChild(descRow);
                
                for (let i = 0; i < rowCount; i++) {
                    const row = document.createElement('tr');
                    if (i === 0) {
                        row.style.backgroundColor = '#fff3e0';
                        row.style.fontWeight = 'bold';
                    }
                    
                    // Time column
                    const timeCell = document.createElement('td');
                    const timeInput = document.createElement('input');
                    timeInput.type = 'number';
                    timeInput.step = '0.1';
                    timeInput.value = (startTime + i * timeStep).toFixed(1);
                    timeInput.className = 'time-input form-control';
                    timeInput.dataset.index = i;
                    timeCell.appendChild(timeInput);
                    
                    // Counts column
                    const countsCell = document.createElement('td');
                    const countsInput = document.createElement('input');
                    countsInput.type = 'number';
                    countsInput.step = '1';
                    countsInput.min = '0';
                    countsInput.value = '0';
                    countsInput.className = 'counts-input form-control';
                    countsInput.dataset.index = i;
                    countsInput.addEventListener('change', function() {
                        updateActivity(this);
                    });
                    countsCell.appendChild(countsInput);
                    
                    // Time count column
                    const timeCountCell = document.createElement('td');
                    const timeCountInput = document.createElement('input');
                    timeCountInput.type = 'number';
                    timeCountInput.step = '0.1';
                    timeCountInput.min = '0.1';
                    timeCountInput.value = i === 0 ? '5.0' : '1.0';
                    timeCountInput.className = 'time-count-input form-control';
                    timeCountInput.dataset.index = i;
                    timeCountInput.addEventListener('change', function() {
                        updateActivity(this);
                    });
                    timeCountCell.appendChild(timeCountInput);
                    
                    // Net activity column (calculated)
                    const netActivityCell = document.createElement('td');
                    netActivityCell.textContent = '0.00';
                    netActivityCell.className = 'net-activity';
                    netActivityCell.dataset.index = i;
                    
                    row.appendChild(timeCell);
                    row.appendChild(countsCell);
                    row.appendChild(timeCountCell);
                    row.appendChild(netActivityCell);
                    
                    tbody.appendChild(row);
                }
                
                // Update all net activities
                document.querySelectorAll('.counts-input, .time-count-input').forEach(updateActivity);
                
                document.getElementById('rowCountDisplay').textContent = rowCount;
                showMessage("‚úÖ Tabla actualizada a " + rowCount + " filas.", "success");
            } catch (error) {
                console.error("Error en resizeTable:", error);
                showMessage("Error al actualizar la tabla: " + error.message, "error");
            }
        }
        
        function calculateBackground() {
            try {
                if (!document.getElementById('useBackground').checked) {
                    showMessage('La correcci√≥n de fondo est√° desactivada. Active la opci√≥n para calcular.', "warning");
                    return;
                }
                
                const method = document.getElementById('backgroundMethod').value;
                if (method === 'manual') {
                    const manualValue = parseFloat(document.getElementById('manualBackgroundValue').value);
                    if (isNaN(manualValue) || manualValue < 0) {
                        showMessage('El valor del fondo debe ser un n√∫mero positivo', "error");
                        return;
                    }
                    backgroundValue = manualValue;
                    backgroundError = Math.sqrt(manualValue);
                    updateBackgroundDisplay();
                    applyBackgroundToTable();
                    showMessage(`‚úÖ Fondo establecido manualmente: ${backgroundValue.toFixed(2)} ¬± ${backgroundError.toFixed(2)} C/min`, "success");
                    return;
                }
                
                const pointsCount = parseInt(document.getElementById('backgroundPoints').value) || 5;
                const countsInputs = document.querySelectorAll('.counts-input');
                const timeCountInputs = document.querySelectorAll('.time-count-input');
                
                if (countsInputs.length < pointsCount) {
                    showMessage(`No hay suficientes puntos en la tabla. Se necesitan al menos ${pointsCount} puntos para calcular el fondo.`, "error");
                    return;
                }
                
                let backgroundSum = 0;
                let validPoints = 0;
                for (let i = 0; i < pointsCount; i++) {
                    if (!countsInputs[i] || !timeCountInputs[i]) {
                        console.error(`Input en √≠ndice ${i} no encontrado.`);
                        continue;
                    }
                    const counts = parseFloat(countsInputs[i].value) || 0;
                    const timeCount = parseFloat(timeCountInputs[i].value) || 1;
                    if (isNaN(counts) || counts < 0 || isNaN(timeCount) || timeCount <= 0) continue;
                    const rawActivity = counts / timeCount;
                    backgroundSum += rawActivity;
                    validPoints++;
                }
                
                if (validPoints === 0) {
                    showMessage('No se encontraron valores v√°lidos para calcular el fondo.', "error");
                    return;
                }
                
                backgroundValue = backgroundSum / validPoints;
                backgroundError = Math.sqrt(backgroundValue);
                updateBackgroundDisplay();
                applyBackgroundToTable();
                showMessage(`‚úÖ Fondo calculado de ${validPoints} puntos: ${backgroundValue.toFixed(2)} ¬± ${backgroundError.toFixed(2)} C/min`, "success");
            } catch (error) {
                console.error("Error en calculateBackground:", error);
                showMessage("Error al calcular el fondo: " + error.message, "error");
            }
        }
        
        function updateBackgroundDisplay() {
            try {
                const displayValue = document.getElementById('backgroundValueDisplay');
                const displayError = document.getElementById('backgroundErrorDisplay');
                if (displayValue && displayError) {
                    displayValue.textContent = backgroundValue.toFixed(2);
                    displayError.textContent = backgroundError.toFixed(2);
                } else {
                    console.error("Elementos de display de fondo no encontrados.");
                }
            } catch (error) {
                console.error("Error en updateBackgroundDisplay:", error);
            }
        }
        
        function applyBackgroundToTable() {
            try {
                // Actualizar todas las actividades netas
                document.querySelectorAll('.counts-input, .time-count-input').forEach(updateActivity);
                showMessage(`‚úÖ Correcci√≥n de fondo aplicada a la tabla. Valor usado: ${backgroundValue.toFixed(2)} C/min`, "success");
            } catch (error) {
                console.error("Error en applyBackgroundToTable:", error);
                showMessage("Error al aplicar el fondo a la tabla: " + error.message, "error");
            }
        }
        
        function autoFillTimes() {
            try {
                const startTime = parseFloat(document.getElementById('startTime').value);
                const timeStep = parseFloat(document.getElementById('timeStep').value);
                if (isNaN(startTime) || isNaN(timeStep) || timeStep <= 0) {
                    showMessage('Por favor, introduzca valores num√©ricos v√°lidos para el tiempo inicial y el paso de tiempo (mayor que 0)', "error");
                    return;
                }
                
                const timeInputs = document.querySelectorAll('.time-input');
                const coolingTime = parseFloat(document.getElementById('coolingTime').value) || 0;
                const longCountTime = parseFloat(document.getElementById('longCountTime').value) || 5;
                
                for (let i = 0; i < timeInputs.length; i++) {
                    if (!timeInputs[i]) {
                        console.warn(`Input de tiempo en √≠ndice ${i} no encontrado, saltando.`);
                        continue;
                    }
                    
                    if (i === 0) {
                        // Primera fila: medida larga (tiempo hasta el centro del contaje)
                        timeInputs[i].value = (coolingTime + longCountTime / 2).toFixed(1);
                    } else {
                        // Otras filas: medidas recurrentes
                        timeInputs[i].value = (startTime + i * timeStep).toFixed(1);
                    }
                }
                
                // Update activities after filling times
                document.querySelectorAll('.counts-input, .time-count-input').forEach(updateActivity);
                showMessage(`‚úÖ Tiempos rellenados correctamente`, "success");
            } catch (error) {
                console.error("Error en autoFillTimes:", error);
                showMessage("Error al rellenar tiempos: " + error.message, "error");
            }
        }
        
        function loadActivityFromFile() {
            try {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput) {
                    console.error("Elemento 'fileInput' no encontrado.");
                    showMessage('Error: Elemento de entrada de archivo no encontrado en la p√°gina', 'error');
                    return;
                }
                const file = fileInput.files[0];
                if (!file) {
                    showMessage('‚úÖ Por favor, seleccione un archivo .txt', "error");
                    return;
                }
                
                // Verificar que el archivo sea de texto
                if (!file.type.match('text.*') && !file.name.toLowerCase().endsWith('.txt')) {
                    showMessage('Por favor, seleccione un archivo de texto (.txt)', "error");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        console.log("Contenido del archivo:", text);
                        
                        // Correcci√≥n: usar \n en lugar del car√°cter especial
                        let lines = text.split('\n').map(line => line.trim()).filter(line => line !== '');
                        
                        // Alternativa si el primer split no funciona (para diferentes formatos de nueva l√≠nea)
                        if (lines.length === 1 && text.includes('\r')) {
                            lines = text.split('\r').map(line => line.trim()).filter(line => line !== '');
                        }
                        
                        if (lines.length === 0) {
                            showMessage('El archivo est√° vac√≠o o no contiene datos v√°lidos.', "error");
                            return;
                        }
                        
                        // Redimensionar la tabla para acomodar los datos del archivo
                        document.getElementById('rowCount').value = lines.length;
                        resizeTable();
                        
                        const countsInputs = document.querySelectorAll('.counts-input');
                        const itemsToProcess = Math.min(lines.length, countsInputs.length);
                        let successfulLoads = 0;
                        
                        for (let i = 0; i < itemsToProcess; i++) {
                            if (!countsInputs[i]) {
                                console.warn(`Input de actividad en √≠ndice ${i} no encontrado despu√©s de redimensionar.`);
                                continue;
                            }
                            
                            // Manejar diferentes formatos de datos
                            let value;
                            if (lines[i].includes(',')) {
                                // Si el archivo tiene formato CSV: tiempo,actividad
                                const parts = lines[i].split(',');
                                if (parts.length >= 2) {
                                    const timeValue = parseFloat(parts[0].trim());
                                    if (!isNaN(timeValue)) {
                                        document.querySelectorAll('.time-input')[i].value = timeValue.toFixed(1);
                                    }
                                    value = parseFloat(parts[1].trim());
                                } else {
                                    value = parseFloat(lines[i]);
                                }
                            } else {
                                // Si solo tiene un valor por l√≠nea (actividad)
                                value = parseFloat(lines[i]);
                            }
                            
                            if (isNaN(value)) {
                                console.warn(`El valor en la l√≠nea ${i + 1} no es un n√∫mero v√°lido: "${lines[i]}"`);
                                continue;
                            }
                            
                            if (value < 0) {
                                console.warn(`El valor en la l√≠nea ${i + 1} es negativo: ${value}`);
                                continue;
                            }
                            
                            countsInputs[i].value = value.toFixed(0);
                            updateActivity(countsInputs[i]);
                            successfulLoads++;
                        }
                        
                        if (successfulLoads === 0) {
                            showMessage('No se pudieron cargar valores v√°lidos del archivo.', 'error');
                        } else if (successfulLoads < lines.length) {
                            showMessage(`‚úÖ Cargados ${successfulLoads} valores v√°lidos. El archivo ten√≠a ${lines.length} l√≠neas.`, "success");
                        } else {
                            showMessage(`‚úÖ Cargados ${successfulLoads} valores del archivo correctamente.`, "success");
                        }
                        
                        // Recalcular fondo si es autom√°tico
                        if (document.getElementById('backgroundMethod').value === 'auto') {
                            setTimeout(calculateBackground, 100); // Peque√±o retraso para asegurar que el DOM est√© actualizado
                        }
                        
                    } catch (error) {
                        console.error("Error detallado al leer el archivo:", error);
                        showMessage('Error al leer el archivo: ' + error.message, "error");
                    }
                };
                reader.onerror = function(e) {
                    console.error("Error de lectura de archivo:", e);
                    showMessage('Error al leer el archivo: ' + (e.message || 'Error desconocido'), "error");
                };
                reader.readAsText(file);
            } catch (error) {
                console.error("Error en loadActivityFromFile:", error);
                showMessage("Error al cargar actividad desde archivo: " + error.message, "error");
            }
        }
        
        function showDataPreview() {
            try {
                const timeInputs = document.querySelectorAll('.time-input');
                const countsInputs = document.querySelectorAll('.counts-input');
                const timeCountInputs = document.querySelectorAll('.time-count-input');
                const netActivityCells = document.querySelectorAll('.net-activity');
                
                let previewText = `<div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">Vista Previa de Datos</h3>
                    </div>
                    <pre style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: monospace; max-height: 300px; overflow: auto;">
Fila    Tiempo (min)    Cuentas    T. Contaje (min)    Actividad Neta (C/min)
----------------------------------------------------------------------
`;
                
                const maxPoints = Math.min(15, timeInputs.length);
                let nonZeroCount = 0;
                
                for (let i = 0; i < maxPoints; i++) {
                    if (!timeInputs[i] || !countsInputs[i] || !timeCountInputs[i] || !netActivityCells[i]) {
                        continue;
                    }
                    
                    const time = parseFloat(timeInputs[i].value);
                    const counts = parseFloat(countsInputs[i].value);
                    const timeCount = parseFloat(timeCountInputs[i].value);
                    const netActivity = parseFloat(netActivityCells[i].textContent);
                    
                    if (!isNaN(counts) && counts > 0) nonZeroCount++;
                    
                    previewText += `${i+1}\t${time.toFixed(1)}\t\t${counts.toFixed(0)}\t${timeCount.toFixed(1)}\t\t${netActivity.toFixed(2)}\n`;
                }
                
                previewText += `                    </pre>
                    <div style="padding: 15px; background: #1a202c; border-radius: 0 0 8px 8px; color: #a0aec0;">
                        <p><strong>Total de registros:</strong> ${timeInputs.length}</p>
                        <p><strong>Registros con cuentas > 0:</strong> ${nonZeroCount}</p>
                        <p><strong>Valor actual del fondo:</strong> ${backgroundValue.toFixed(2)} ¬± ${backgroundError.toFixed(2)} C/min</p>
                        <p style="color: #63b3ed; margin-top: 10px;"><i class="fas fa-info-circle"></i> NOTA: La primera fila corresponde a la MEDIDA LARGA.</p>
                    </div>
                </div>`;
                
                const previewDiv = document.getElementById('dataPreview');
                if (previewDiv) {
                    previewDiv.innerHTML = previewText;
                    previewDiv.style.display = 'block';
                } else {
                    console.error("Elemento 'dataPreview' no encontrado.");
                }
                
                showMessage("‚úÖ Vista previa de datos generada", "success");
            } catch (error) {
                console.error("Error en showDataPreview:", error);
                showMessage("Error al mostrar vista previa: " + error.message, "error");
            }
        }
        
        function addRow() {
            const rowCount = parseInt(document.getElementById('rowCount').value) || 10;
            document.getElementById('rowCount').value = rowCount + 1;
            resizeTable();
            document.getElementById('rowCountDisplay').textContent = rowCount + 1;
            showMessage("‚úÖ Fila a√±adida correctamente", "success");
        }
        
        function clearTable() {
            if (confirm("‚ö†Ô∏è ¬øEst√° seguro de que quiere limpiar toda la tabla? Se perder√°n todos los datos introducidos.")) {
                const rowCount = parseInt(document.getElementById('rowCount').value) || 10;
                // Reiniciar valores a los por defecto
                document.querySelectorAll('.time-input').forEach(input => {
                    input.value = (parseFloat(document.getElementById('startTime').value) + 
                                  (parseInt(input.dataset.index) * parseFloat(document.getElementById('timeStep').value))).toFixed(1);
                });
                
                document.querySelectorAll('.counts-input').forEach(input => {
                    input.value = '0';
                    updateActivity(input);
                });
                
                document.querySelectorAll('.time-count-input').forEach((input, index) => {
                    input.value = (index === 0) ? '5.0' : '1.0';
                    updateActivity(input);
                });
                
                showMessage("‚úÖ Tabla limpiada y restablecida a valores por defecto", "success");
            }
        }
        
        function calculateLambda() {
            try {
                // Limpiar mensajes anteriores
                showMessage("", ""); 
                
                // Obtener par√°metros espec√≠ficos de la medida larga
                const coolingTime = parseFloat(document.getElementById('coolingTime').value);
                const longCountTime = parseFloat(document.getElementById('longCountTime').value);
                const irradiationTime = parseFloat(document.getElementById('irradiationTime').value);
                
                if (isNaN(coolingTime) || coolingTime < 0) {
                    showMessage('El tiempo de enfriamiento debe ser un n√∫mero v√°lido >= 0', "error");
                    return;
                }
                
                if (isNaN(longCountTime) || longCountTime <= 0) {
                    showMessage('El tiempo de contaje de la medida larga debe ser un n√∫mero > 0', "error");
                    return;
                }
                
                if (isNaN(irradiationTime) || irradiationTime <= 0) {
                    showMessage('Por favor, introduzca un valor v√°lido para el tiempo de irradiaci√≥n (mayor que 0)', "error");
                    return;
                }
                
                // Tiempo del centro de la medida larga (desde fin de irradiaci√≥n)
                const longMeasureTime = coolingTime + longCountTime / 2;
                
                const timeInputs = document.querySelectorAll('.time-input');
                const netActivityCells = document.querySelectorAll('.net-activity');
                const countsInputs = document.querySelectorAll('.counts-input');
                const timeCountInputs = document.querySelectorAll('.time-count-input');
                
                // Verificar que existan elementos
                if (timeInputs.length === 0 || netActivityCells.length === 0) {
                    showMessage("La tabla no contiene filas de datos.", "error");
                    return;
                }
                
                // Separar datos: primera fila = medida larga, resto = medidas recurrentes
                let longMeasureData = null;
                const times = [];
                const activities = [];
                
                // Primera fila: medida larga
                if (timeInputs[0] && netActivityCells[0] && countsInputs[0] && timeCountInputs[0]) {
                    const timeValue = parseFloat(timeInputs[0].value);
                    const activityValue = parseFloat(netActivityCells[0].textContent);
                    const countsValue = parseFloat(countsInputs[0].value) || 0;
                    const timeCountValue = parseFloat(timeCountInputs[0].value) || 1;
                    
                    if (isNaN(timeValue) || timeValue < 0) {
                        showMessage('El tiempo en la medida larga debe ser un n√∫mero v√°lido >= 0', "error");
                        return;
                    }
                    
                    if (isNaN(activityValue) || activityValue <= 0) {
                        showMessage('El valor de actividad neta en la medida larga debe ser un n√∫mero positivo', "error");
                        return;
                    }
                    
                    longMeasureData = {
                        time: timeValue,
                        netActivity: activityValue,
                        counts: countsValue,
                        countTime: timeCountValue
                    };
                } else {
                    showMessage('La primera fila (medida larga) no est√° completa. Compl√©tela antes de calcular.', "error");
                    return;
                }
                
                // Resto de filas: medidas recurrentes (solo si son v√°lidas)
                let validRecurrentPoints = 0;
                for (let i = 1; i < timeInputs.length && i < netActivityCells.length; i++) {
                    if (!timeInputs[i] || !netActivityCells[i] || !countsInputs[i] || !timeCountInputs[i]) continue;
                    
                    const timeValue = parseFloat(timeInputs[i].value);
                    const activityValue = parseFloat(netActivityCells[i].textContent);
                    
                    if (isNaN(timeValue) || timeValue < 0) continue;
                    if (isNaN(activityValue) || activityValue <= 0) continue;
                    
                    times.push(timeValue);
                    activities.push(activityValue);
                    validRecurrentPoints++;
                }
                
                if (validRecurrentPoints < 3) {
                    showMessage('Se necesitan al menos 3 puntos v√°lidos de medidas recurrentes (adem√°s de la medida larga) para realizar el ajuste.', "error");
                    return;
                }
                
                // Ajuste lineal en log(actividad) con medidas recurrentes
                const logActivities = activities.map(a => {
                    if (a <= 0) {
                        throw new Error(`Actividad no positiva encontrada: ${a}`);
                    }
                    return Math.log(a);
                });
                
                const n = times.length;
                const sumX = times.reduce((sum, x) => sum + x, 0);
                const sumY = logActivities.reduce((sum, y) => sum + y, 0);
                const sumXY = times.reduce((sum, x, i) => sum + x * logActivities[i], 0);
                const sumX2 = times.reduce((sum, x) => sum + x * x, 0);
                
                const meanX = sumX / n;
                const meanY = sumY / n;
                
                const numerator = sumXY - n * meanX * meanY;
                const denominator = sumX2 - n * meanX * meanX;
                
                if (Math.abs(denominator) < 1e-10) {
                    showMessage('Error: La variaci√≥n en los tiempos es insuficiente para realizar el ajuste.', "error");
                    return;
                }
                
                // CORRECCI√ìN PRINCIPAL: Para un decaimiento radiactivo, la pendiente debe ser negativa
                // lambda = |pendiente| (siempre positiva)
                const slope = numerator / denominator;
                const lambda = Math.abs(slope); // lambda siempre positiva para decaimiento
                const intercept = meanY - slope * meanX;
                const A0 = Math.exp(intercept); // A0 en C/min
                
                // Verificaci√≥n adicional: si la pendiente es positiva, los datos est√°n invertidos
                if (slope > 0) {
                    showMessage('Advertencia: Los datos muestran un crecimiento exponencial, no un decaimiento. Verifique el orden de los tiempos.', "warning");
                }
                
                const halfLife = Math.log(2) / lambda;
                const meanLife = 1 / lambda;
                
                // CALCULAR ACTIVIDAD DE SATURACI√ìN USANDO LA MEDIDA LARGA (F√ìRMULA INTEGRAL)
                let saturationActivity = NaN;
                let saturationFactor = NaN;
                
                if (longMeasureData) {
                    const t_cool = coolingTime; // Tiempo de enfriamiento puro
                    const t_count = longCountTime;
                    
                    // F√≥rmula integral para calcular As
                    // As = (N * lambda) / [(1 - e^(-lambda*t_irr)) * e^(-lambda*t_cool) * (1 - e^(-lambda*t_count))]
                    const N = longMeasureData.counts; // Cuentas totales
                    const numeratorAs = N * lambda;
                    const exp_term1 = Math.exp(-lambda * irradiationTime);
                    const exp_term2 = Math.exp(-lambda * t_cool);
                    const exp_term3 = Math.exp(-lambda * t_count);
                    
                    const denominatorAs = (1 - exp_term1) * exp_term2 * (1 - exp_term3);
                    
                    if (Math.abs(denominatorAs) > 1e-10) {
                        saturationActivity = numeratorAs / denominatorAs;
                        saturationFactor = A0 / saturationActivity;
                    } else {
                        // Fallback a m√©todo aproximado si hay problemas
                        const exp_factor = Math.exp(-lambda * irradiationTime);
                        if (Math.abs(1 - exp_factor) > 1e-10) {
                            saturationActivity = A0 / (1 - exp_factor);
                            saturationFactor = A0 / saturationActivity;
                            showMessage('Advertencia: Se us√≥ m√©todo aproximado para calcular As. Verifique los par√°metros.', "warning");
                        } else {
                            showMessage('Error: No se puede calcular As con los par√°metros introducidos.', "error");
                        }
                    }
                } else {
                    // Si no hay medida larga v√°lida, usar m√©todo aproximado
                    const exp_factor = Math.exp(-lambda * irradiationTime);
                    if (Math.abs(1 - exp_factor) > 1e-10) {
                        saturationActivity = A0 / (1 - exp_factor);
                        saturationFactor = A0 / saturationActivity;
                    } else {
                        showMessage('Error: No se puede calcular As con los par√°metros introducidos.', "error");
                    }
                }
                
                // C√°lculo de R¬≤ (solo con medidas recurrentes)
                let ssTot = 0;
                let ssRes = 0;
                for (let i = 0; i < times.length; i++) {
                    const yPred = slope * times[i] + intercept;
                    ssTot += Math.pow(logActivities[i] - meanY, 2);
                    ssRes += Math.pow(logActivities[i] - yPred, 2);
                }
                const rSquared = ssTot !== 0 ? 1 - (ssRes / ssTot) : 0;
                
                // Mostrar resultados con unidades correctas
                document.getElementById('lambdaValue').textContent = lambda.toFixed(6);
                document.getElementById('a0Value').textContent = A0.toFixed(2);
                document.getElementById('halfLifeValue').textContent = halfLife.toFixed(4);
                document.getElementById('saturationActivityValue').textContent = isFinite(saturationActivity) ? saturationActivity.toFixed(2) : 'N/A';
                document.getElementById('rSquared').textContent = rSquared.toFixed(4);
                document.getElementById('saturationFactorValue').textContent = isFinite(saturationFactor) ? saturationFactor.toFixed(4) : 'N/A';
                document.getElementById('backgroundValue').textContent = backgroundValue.toFixed(2);
                document.getElementById('equation').textContent = 
                    `A(t) = ${A0.toFixed(2)} ¬∑ e^(-${lambda.toFixed(6)} ¬∑ t)  [C/min]`;
                
                // Preparar datos para el gr√°fico
                // 1. Datos experimentales: todas las medidas
                const allTimes = [longMeasureData.time, ...times];
                const allActivities = [longMeasureData.netActivity, ...activities];
                const originalData = allTimes.map((t, i) => ({x: t, y: allActivities[i]}));
                
                // 2. Curva de ajuste: desde t=0 hasta el m√°ximo tiempo
                const maxTime = Math.max(...allTimes) * 1.1;
                const fittedData = [];
                for (let t = 0; t <= maxTime; t += 0.1) {
                    fittedData.push({x: t, y: A0 * Math.exp(-lambda * t)});
                }
                
                // Destacar la medida larga en el gr√°fico
                if (longMeasureData) {
                    originalData[0].backgroundColor = 'rgba(255, 152, 0, 0.9)'; // Naranja brillante
                    originalData[0].borderColor = 'rgba(255, 152, 0, 1)';
                    originalData[0].pointRadius = 8;
                    originalData[0].pointStyle = 'star';
                }
                
                // Crear gr√°fico
                createChart(originalData, fittedData);
                
                // Actualizar tabla de resultados
                updateResultsTable(times, activities, A0, lambda);
                
                // Mostrar secci√≥n de resultados
                document.getElementById('resultsPlaceholder').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                
                // Mostrar mensaje informativo
                let message = `‚úÖ An√°lisis completado con √©xito!<br>`;
                message += `‚Ä¢ ${validRecurrentPoints} puntos de medidas recurrentes<br>`;
                message += `‚Ä¢ 1 medida larga (${longCountTime} min)<br>`;
                message += `‚Ä¢ Œª = ${lambda.toFixed(6)} min‚Åª¬π<br>`;
                message += `‚Ä¢ T¬Ω = ${halfLife.toFixed(2)} min<br>`;
                message += `‚Ä¢ R¬≤ = ${rSquared.toFixed(4)}<br>`;
                message += `‚Ä¢ As = ${isFinite(saturationActivity) ? saturationActivity.toFixed(2) : 'N/A'} C/min`;
                
                showMessage(message, "success");
                
            } catch (error) {
                showMessage('Error en el c√°lculo: ' + error.message, "error");
                console.error("Error detallado en calculateLambda:", error);
            }
        }
        
        function createChart(originalData, fittedData) {
            try {
                const ctx = document.getElementById('resultsChart').getContext('2d');
                if (!ctx) {
                    console.error("Contexto del canvas no encontrado.");
                    return;
                }
                if (myChart) {
                    myChart.destroy();
                }
                myChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                label: 'Medidas recurrentes',
                                data: originalData.slice(1),
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            },
                            {
                                label: 'Medida larga',
                                data: [originalData[0]],
                                backgroundColor: 'rgba(255, 152, 0, 0.9)',
                                borderColor: 'rgba(255, 152, 0, 1)',
                                borderWidth: 2,
                                pointRadius: 8,
                                pointStyle: 'star',
                                pointHoverRadius: 10
                            },
                            {
                                label: 'Ajuste exponencial',
                                data: fittedData,
                                borderColor: 'rgba(219, 68, 55, 1)',
                                backgroundColor: 'rgba(219, 68, 55, 0.1)',
                                borderWidth: 3,
                                pointRadius: 0,
                                showLine: true,
                                fill: false,
                                lineTension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Tiempo (minutos desde fin de irradiaci√≥n)',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Actividad Neta (C/min)',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 13
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 13
                                }
                            },
                            title: {
                                display: true,
                                text: 'Curva de Desintegraci√≥n Radiactiva',
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 20
                                }
                            }
                        },
                        animation: {
                            duration: 1500,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            } catch (error) {
                console.error("Error en createChart:", error);
                showMessage("Error al crear el gr√°fico: " + error.message, "error");
            }
        }
        
        function updateResultsTable(times, activities, A0, lambda) {
            try {
                const tableBody = document.getElementById('resultsTableBody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                for (let i = 0; i < times.length && i < activities.length; i++) {
                    const t = times[i];
                    const expActivity = activities[i];
                    const theoActivity = A0 * Math.exp(-lambda * t);
                    const error = Math.abs((expActivity - theoActivity) / theoActivity) * 100;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${t.toFixed(1)}</td>
                        <td>${expActivity.toFixed(2)}</td>
                        <td>${theoActivity.toFixed(2)}</td>
                        <td>${error.toFixed(2)}%</td>
                    `;
                    tableBody.appendChild(row);
                }
            } catch (error) {
                console.error("Error en updateResultsTable:", error);
            }
        }
        
        function exportResults() {
            try {
                if (!document.getElementById('resultsSection').style.display || 
                    document.getElementById('resultsSection').style.display === 'none') {
                    showMessage('No hay resultados para exportar. Realice el c√°lculo primero.', 'error');
                    return;
                }
                
                const lambdaValue = document.getElementById('lambdaValue').textContent;
                const a0 = document.getElementById('a0Value').textContent;
                const halfLife = document.getElementById('halfLifeValue').textContent;
                const saturationActivity = document.getElementById('saturationActivityValue').textContent;
                const saturationFactor = document.getElementById('saturationFactorValue').textContent;
                const background = document.getElementById('backgroundValue').textContent;
                const rSquared = document.getElementById('rSquared').textContent;
                
                const timeInputs = document.querySelectorAll('.time-input');
                const countsInputs = document.querySelectorAll('.counts-input');
                const timeCountInputs = document.querySelectorAll('.time-count-input');
                const netActivityCells = document.querySelectorAll('.net-activity');
                
                let csvContent = "Resultados del an√°lisis de desintegraci√≥n radiactiva\n";
                csvContent += "Fecha de exportaci√≥n: " + new Date().toLocaleString() + "\n";
                csvContent += "Par√°metro,Valor,Unidades\n";
                csvContent += `Constante de desintegraci√≥n (lambda),${lambdaValue},min^-1\n`;
                csvContent += `Actividad inicial A(0),${a0},C/min\n`;
                csvContent += `T1/2,${halfLife},minutos\n`;
                csvContent += `Actividad de saturaci√≥n As,${saturationActivity},C/min\n`;
                csvContent += `Factor de saturaci√≥n A(0)/As,${saturationFactor},adimensional\n`;
                csvContent += `Valor del fondo,${background},C/min\n`;
                csvContent += `Coeficiente de determinaci√≥n (R^2),${rSquared},adimensional\n`;
                csvContent += `\nEcuaci√≥n de ajuste\n`;
                csvContent += `${document.getElementById('equation').textContent}\n`;
                csvContent += "Datos experimentales\n";
                csvContent += "Tiempo (min),Cuentas Totales,Tiempo Contaje (min),Actividad Neta (C/min)\n";
                
                for (let i = 0; i < timeInputs.length; i++) {
                    if (timeInputs[i] && countsInputs[i] && timeCountInputs[i] && netActivityCells[i]) {
                        const time = timeInputs[i].value;
                        const counts = countsInputs[i].value;
                        const timeCount = timeCountInputs[i].value;
                        const netActivity = netActivityCells[i].textContent;
                        csvContent += `${time},${counts},${timeCount},${netActivity}\n`;
                    }
                }
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "resultados_desintegracion_" + new Date().toISOString().replace(/[:.]/g, '-') + ".csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("‚úÖ Resultados exportados correctamente como CSV", "success");
            } catch (error) {
                console.error("Error en exportResults:", error);
                showMessage("Error al exportar resultados: " + error.message, "error");
            }
        }
        
        function exportChart() {
            try {
                if (!myChart) {
                    showMessage("No hay gr√°fica para exportar. Realice el c√°lculo primero.", "error");
                    return;
                }
                const imageData = myChart.toBase64Image('image/png', 1);
                const link = document.createElement('a');
                link.href = imageData;
                link.download = 'grafica_desintegracion_' + new Date().toISOString().replace(/[:.]/g, '-') + '.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("‚úÖ Gr√°fica exportada correctamente como PNG", "success");
            } catch (error) {
                console.error("Error en exportChart:", error);
                showMessage('Error al exportar la gr√°fica: ' + error.message, "error");
            }
        }
        
        function showMessage(message, type) {
            try {
                const container = document.getElementById('messageContainer');
                if (!container) return;
                
                // Remove oldest message if more than 3
                while (container.children.length > 3) {
                    container.removeChild(container.children[0]);
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = message;
                container.appendChild(messageDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    messageDiv.style.animation = 'slideOut 0.3s ease forwards';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }, 5000);
            } catch (error) {
                console.error("Error en showMessage:", error);
            }
        }
    </script>
</body>
</html>



